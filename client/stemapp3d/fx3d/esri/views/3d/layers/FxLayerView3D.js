/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","esri/views/layers/LayerView","esri/Graphic","esri/layers/GraphicsLayer","esri/layers/graphics/controllers/SnapshotController","esri/geometry/Point","esri/geometry/Extent","esri/views/3d/support/projectionUtils","esri/views/3d/lib/glMatrix","esri/geometry/SpatialReference","esri/core/watchUtils","esri/core/Collection","esri/symbols/PictureMarkerSymbol","esri/geometry/support/coordsUtils","../effects/FxEffectRenderer","../effects/FxEffectFactory","../support/fx3dUtils"],function(e,i,t,a,r,l,s,n,o,h,c,d,u,y,p,f,v,_,g){var m=300,w=c.vec3,b=w.create(),F=w.create(),L=w.create(),x=w.create(),z=w.create(),H=e(a,{declaredClass:"esri.views.3d.layers.FxLayerView3D",constructor:function(){this._perPageScale=1,this._fx3dSpatialReference=d.WGS84},initialize:function(){this.layer.then(function(){v.init(this.view),this._eventHandles=[],this.loadedGraphics=null,this._graphicsLoading=!0,this._graphicsCollectionEventHandle=null,this._graphicsControllerEventHandles=[];var e=this._initEffect();e.then(i.hitch(this,this._initGraphicsController)),this.addResolvingPromise(e),this._eventHandles.push(this.layer.on("destroy-fxlayer",function(){v.pause()}.bind(this))),this._eventHandles.push(this.layer.on("show-feature-label",i.hitch(this,this._onShowFeatureLabel))),this._eventHandles.push(this.layer.on("hide-feature-label",function(){this._labelsLayer&&(this._labelsLayer.removeAll(),this._selectedFeature=null)}.bind(this))),this._eventHandles.push(this.view.on("click",i.hitch(this,this._viewClicked))),this._initLabelInfo()}.bind(this))},destroy:function(){this._viewModelHandler&&(this._viewModelHandler.remove(),this._viewModelHandler=null),this._labelsLayer&&(this._labelsLayer.removeAll(),this.view.map.remove(this._labelsLayer),delete this._labelsLayer,this._labelsLayer=null),v.destroy(this._layerVizType,this._layerId);var e=function(e){e.remove()};this.controller&&(this.controller.destroy(),this.controller=null),this._graphicsCollectionEventHandle&&this._graphicsCollectionEventHandle.remove(),this._graphicsControllerEventHandles.forEach(e),this._tilingSchemeHandle&&this._tilingSchemeHandle.remove(),this._eventHandles.forEach(e)},getLoadedGraphics:function(){return this.loadedGraphics&&this.loadedGraphics.toArray?[].concat(this.loadedGraphics.toArray()):[]},_initEffect:function(){return _.make({layer:this.layer,layerView:this,view:this.view})},_initLabelInfo:function(){this._labelsLayer=new l({id:this.layer.id+"-labelinfo-layer"}),this.view.map.add(this._labelsLayer),this.layer.watch("visible",function(e,i,t){this._labelsLayer&&this._labelsLayer.set("visible",e?!0:!1)}.bind(this))},_getGeomZFromPolyline:function(e,i){return w.set3(e[0],e[1],e[2]||1,F),g.wgs84ToSphericalEngineCoords(F,0,F,0),w.set3(i[0],i[1],i[2]||1,L),g.wgs84ToSphericalEngineCoords(L,0,L,0),w.subtract(F,L,z),w.add(F,L,x),w.scale(x,.5),w.length(x)+.6001*w.length(z)-6378137},_calculatePerfectPosition:function(e){var i={};if(null==e||null==e.geometry)return console.warn("Feature or geometry is invalid."),i;var t,a,r,l=e.geometry;if("esriGeometryPoint"===this.layer.geometryType){i.x=l.longitude,i.y=l.latitude;var s=this.layer._labelDefaultHeight;i.z=5e3,s&&this.layer._currentVizFieldMinMax&&(r=this.layer._currentVizFieldMinMax.max-this.layer._currentVizFieldMinMax.min,r&&"number"==typeof this.layer._currentVizPage&&(t=this.layer.vizFields[this.layer._currentVizPage],a=e.attributes[t],null!=a&&(0===s.flag?(i.z+=s.max,i.z*=(a-this.layer._currentVizFieldMinMax.min)/r):1===s.flag&&(s.max===s.min?i.z+=s.max:i.z+=s.min+(s.max-s.min)*(a-this.layer._currentVizFieldMinMax.min)/r))))}else if("esriGeometryPolyline"===this.layer.geometryType){if(null==l.paths)return console.warn("Paths of feature is invalid."),i;var n=l.paths[0],o=n.length;i.x=(n[0][0]+n[o-1][0])/2,i.y=(n[0][1]+n[o-1][1])/2,i.z=this._getGeomZFromPolyline(n[0],n[o-1])}else if("esriGeometryPolygon"===this.layer.geometryType){if(null==l.rings)return console.warn("Rings of feature is invalid."),i;var h=f.centroid([],l.rings,!1);if(isNaN(h[0])||isNaN(h[1]))return null;i.x=h[0],i.y=h[1],r=this.layer._currentVizFieldMinMax.max-this.layer._currentVizFieldMinMax.min,r&&(t=this.layer.vizFields[this.layer._currentVizPage],a=e.attributes[t],null!=a&&(i.z+=1e4,i.z*=(a-this.layer._currentVizFieldMinMax.min)/r))}return isNaN(i.z)&&(i.z=null),i},_onShowFeatureLabel:function(e){if(this._labelsLayer&&this._labelsLayer.visible){if(this._selectedFeature=null,e.feature){var i=e.feature.geometry;if(null==i)return void console.warn("The feature with FID has no geometry content.");this._labelsLayer.removeAll();var t=this._calculatePerfectPosition(e.feature);if(!t.x||!t.y||!t.z)return;var a=""+e.feature.attributes[this.layer.displayField],l=g.createTextTexture(a,14,"#ffffff","center","Arial","rgba(0,0,0,0.5)"),s=new p({url:l.toDataURL(),width:l.width,height:l.height,contentType:"image/png"}),h=new n(t.x,t.y,t.z,this._fx3dSpatialReference),c=new r(h,s,e.feature.attributes,this.layer.popupTemplate);this._labelsLayer.add(c);var d=new o(t.x-30,t.y-30,t.x+30,t.y+30,this._fx3dSpatialReference);this._animateTo(d)}else this._labelsLayer.removeAll();this._selectedFeature=e.feature}},_updateSelectedFeatureLabel:function(){if(this._labelsLayer){var e=this._labelsLayer.graphics.toArray().length>0;this._labelsLayer.removeAll(),e&&this._selectedFeature&&this._onShowFeatureLabel({feature:this._selectedFeature})}},_viewClicked:function(e){if(e.graphic){if(this._labelsLayer&&e.graphic.layer===this._labelsLayer)0==this._labelsLayer.graphics.length&&this._onShowFeatureLabel({feature:e.graphic});else if(e.graphic.layer===this.layer&&this.view&&this.view.popup.viewModel.selectedFeature){var t=this.view.popup.viewModel.selectedFeature,a=new r({attributes:i.clone(t.attributes),geometry:t.geometry&&t.geometry.clone()||null,popupTemplate:t.popupTemplate||null,symbol:t.symbol||null,visible:t.visible});if(null==a)return;this._onShowFeatureLabel({feature:a}),this.layer.emit("selected-feature-from-globe",{selectedFeature:a}),this.view.popup.viewModel._set("selectedFeature",null)}}else if(this._labelsLayer&&this._labelsLayer.graphics.length>0&&(this._labelsLayer.removeAll(),this._selectedFeature=null,this.layer.emit("abandon-selected-feature"),this.view&&this.view.popup.viewModel._set("selectedFeature",null)),this.view&&this.view.popup.viewModel.selectedFeature)try{this.view.popup.viewModel.selectedFeature.symbol=null,this.view.popup.viewModel.selectedFeature.popupTemplate=null;var a=this.view.popup.viewModel.selectedFeature.clone();this._onShowFeatureLabel({feature:a}),this.layer.emit("selected-feature-from-globe",{selectedFeature:a})}finally{this.view.popup.viewModel._set("selectedFeature",null)}},_animateTo:function(e,i,t){if(i=i||1,t=t||this._fx3dSpatialReference,this.view){var a=29.32;"local"==this.view.viewingMode&&(a=70.05),this.view.goTo({target:e,heading:0,tilt:a})}},_initGraphicsController:function(e){if(v.add(this.layer,e)){this._layerId=this.layer.id,this._layerVizType=this.layer.vizType;var i=this.view.map.layers.find(function(e){return e.url===this.layer.url&&"esri.layers.FeatureLayer"===e.declaredClass&&"Feature Layer"===e.type&&e.loaded===!0}.bind(this)),t=this,a=function(){var e=y.ofType(r),i={layer:t.layer,layerView:t,maxPageSize:m,graphics:new e};t.controller=new s(i),u.whenTrueOnce(t.view,"basemapTerrain.ready",function(){t.controller.then(function(){var e=null;t.loadedGraphics=t.controller.graphics,t._graphicsCollectionEventHandle=t.loadedGraphics.on("change",t._collectionChangeHandler.bind(t)),t.loadedGraphics.length>0&&(e=t.loadedGraphics.toArray(),t._add([].concat(e))),t._graphicsControllerEventHandles.push(t.controller.on("query-end",function(){t._graphicsLoading=!1}))})})};if(i){var l=this.view.layerViews.find(function(e){return e.layer.url===i.url&&e.layer.id===i.id}.bind(this));l?(i.source&&this.layer._initLayerProperties(i.source),this.loadedGraphics=l.loadedGraphics,this.loadedGraphics.length>0&&this._add([].concat(this.loadedGraphics.toArray())),this.layer.emit("all-features-loaded",{graphics:[].concat(this.loadedGraphics.toArray())})):a()}else a()}},_collectionChangeHandler:function(e){this._add([].concat(e.added)),this._remove([].concat(e.removed))},_add:function(e){function a(e){var i,a,l=[].concat(e);t.forEach(l,function(e){if(i=e.geometry){if("esriGeometryPoint"==r.layer.geometryType)h.xyzToVector(i.x,i.y,i.z,i.spatialReference,b,r._fx3dSpatialReference),i.longitude=b[0],i.latitude=b[1],i.altitude=isNaN(b[2])?null:b[2];else if("esriGeometryPolyline"==r.layer.geometryType||"esriGeometryPolygon"==r.layer.geometryType){a=i.paths||i.rings;for(var t=0;t<a.length;t++)for(var l=0;l<a[t].length;l++)h.xyzToVector(a[t][l][0],a[t][l][1],a[t][l][2],i.spatialReference,b,r._fx3dSpatialReference),a[t][l][0]=b[0],a[t][l][1]=b[1],a[t][l][2]=isNaN(b[2])?null:b[2]}}else console.warn("No geometry information found in feature: "+e.attributes.FID)}),r.layer.emit("fx3d-add-graphics",{graphics:l}),r._graphicsLoading||r.layer.emit("all-features-loaded",{graphics:r.getLoadedGraphics()})}if(i.isArray(e)&&e.length>0){var r=this;this.isResolved()?a(e):this.then(function(){a(e)})}},_remove:function(e){i.isArray(e)&&e.length>0},_basemapTerrainChanged:function(e){this.elevationProvider=e,this._tilingSchemeHandle&&this._tilingSchemeHandle.remove(),e?this._tilingSchemeHandle=u.whenOnce(e,"tilingScheme",this._recreateAllGraphics.bind(this)):this._recreateAllGraphics(),e?(this._elevationUpdateEventHandle=e.on("elevation-change",this._elevationUpdateHandler.bind(this)),this.updateElevation=!1,this._layerMinMaxScaleChangeHandler()):(this._elevationUpdateEventHandle&&(this._elevationUpdateEventHandle.remove(),this._elevationUpdateEventHandle=null),this._scaleChangeEventHandle&&(this._scaleChangeEventHandle.remove(),this._scaleChangeEventHandle=null))}});return H});