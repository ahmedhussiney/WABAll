/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","esri/core/Scheduler","esri/core/watchUtils","esri/views/3d/webgl-engine/lib/ShaderSnippets","esri/views/3d/support/earthUtils","esri/views/3d/lib/glMatrix","esri/views/3d/webgl-engine/lib/RenderSlot","./Effect","../support/fx3dUtils","dojo/text!./CommonShaders.xml"],function(e,t,i,s,n,a,r,_,o,h,c,f){var l=_.mat4d,d=_.vec3d,w={GLOBAL:0,global:"GLOBAL",LOCAL:1,local:"LOCAL"},u=e(null,{declaredClass:"esri.views.3d.effects.FxEffectRenderer",constructor:function(){this._sceneView=null,this._internallyReady=!1,this._effects=[],this._fx3dFrameTask=null,this._shaderSnippets=null,this._normalMatrix=l.create(),this._viewDirection=d.create()},_init:function(e){!this._internallyReady&&t.isObject(e)&&(this._sceneView=e,this._showGround(!1),n.whenTrue(this._sceneView,"ready",this._viewReadyHandler.bind(this)))},_showGround:function(e){if("boolean"==typeof e&&this._sceneView.map&&this._sceneView.map.ground){var t=this._sceneView.map.ground.layers;t.forEach(function(t){t&&t.set("visible",e)})}},_viewReadyHandler_bak:function(){this._gl=this._sceneView._stage&&this._sceneView._stage.view&&this._sceneView._stage.view._gl,this._gl instanceof window.WebGLRenderingContext&&(this._internallyReady!==!0&&(this._enableExtensions()?(this._shaderSnippets||(this._shaderSnippets=new a,this._shaderSnippets._parse(f)),this._internallyReady=!0):c.extensionsMessage()),this._internallyReady&&(this._fx3dFrameTask||this._initializeFrameTask()))},_viewReadyHandler:function(){this._sceneView._stage&&this._sceneView._stage.addExternalRenderer([o.OPAQUE_TERRAIN],this)},_enableExtensions:function(){var e=this._gl.getExtension("OES_element_index_uint")||this._gl.getExtension("MOZ_OES_element_index_uint")||this._gl.getExtension("WEBKIT_OES_element_index_uint");return e&&(e=this._gl.getExtension("OES_texture_float")||this._gl.getExtension("OES_texture_float_linear")||this._gl.getExtension("OES_texture_half_float")||this._gl.getExtension("OES_texture_half_float_linear")),null==e&&console.warn("Some extensions are not supported in this browser."),e?!0:!1},_update:function(){this._lightingData=this._sceneView._stage&&this._sceneView._stage.view._viewport.getLightingData(),this._camera=this._sceneView._stage&&this._sceneView._stage.getCamera(),this._cameraPos=this._camera._eye,this._viewMatrix=this._camera.viewMatrix,this._projMatrix=this._camera.projectionMatrix,this._viewInverseTransposeMatrix=this._camera.viewInverseTransposeMatrix,this._viewport=this._camera.viewport,l.set(this._viewInverseTransposeMatrix,this._normalMatrix),this._normalMatrix[3]=this._normalMatrix[7]=this._normalMatrix[11]=0,d.set3(this._viewMatrix[12],this._viewMatrix[13],this._viewMatrix[14],this._viewDirection)},initializeRenderContext:function(e){this.needsRender=!1,this._gl=e.gl,this._internallyReady!==!0&&(this._enableExtensions()?(this._shaderSnippets||(this._shaderSnippets=new a,this._shaderSnippets._parse(f)),this._internallyReady=!0,this.needsRender=!0):(this._sceneView._stage&&this._sceneView._stage.removeExternalRenderer(this),c.extensionsMessage()))},render:function(e){l.set(e.camera.viewInverseTransposeMatrix,this._normalMatrix),this._normalMatrix[3]=this._normalMatrix[7]=this._normalMatrix[11]=0,this._effects.forEach(function(e){e.effect.preRender()}),this._effects.forEach(function(t){t.effect.render({zoom:this._sceneView.zoom,viewingMode:w[w[this._sceneView.get("viewingMode")]],proj:e.camera.projectionMatrix,view:e.camera.viewMatrix,viewInvTransp:e.camera.viewInverseTransposeMatrix,normalMat:this._normalMatrix,camPos:e.camera._eye,lightingData:e.lightingData,viewport:e.camera.viewport})}.bind(this)),this._effects.forEach(function(e){e.effect.update()})},_initializeFrameTask:function(){var e=this;this._frameTask={preRender:function(){e._update(),e._effects.forEach(function(e){e.effect.preRender()})},render:function(){e._effects.forEach(function(t){t.effect.render({proj:e._projMatrix,view:e._viewMatrix,normalMat:e._normalMatrix,camPos:e._cameraPos,lightingData:e._lightingData,viewport:e._viewport})})},update:function(){e._effects.forEach(function(e){e.effect.update()}),e._sceneView._stage.setNeedsRender()}},this._fx3dFrameTask=s.addFrameTask(this._frameTask)},_add:function(e,s){if(t.isObject(e)&&"esri.layers.FxLayer"===e.declaredClass&&s instanceof h){var n=i.filter(this._effects,function(t){return t.id===e.id&&t.effect.effectName==s.effectName?!0:!1});if(n.length>0)return console.warn("Layer "+e.id+" in "+s.effectName+" effect has already existed."),!1;if(t.isObject(s))return this._effects.push({id:e.id,effect:s}),"function"==typeof s.setContext&&s.setContext({gl:this._gl,shaderSnippets:this._shaderSnippets}),!0}return!1},_remove:function(e,t){if(e&&t){var s=-1,n=i.filter(this._effects,function(i,n){return i.id===t&&e==i.effect.effectName?(s=n,!0):!1});n.length>0&&s>-1&&(n[0].effect.destroy(),this._effects.splice(s,1)),0===this._effects.length&&(this._fx3dFrameTask&&(this._fx3dFrameTask.remove(),this._fx3dFrameTask=null),this._internallyReady=!1,this._sceneView._stage&&this._sceneView._stage.removeExternalRenderer(this),this._showGround(!0))}}}),x=null;return u.init=function(e){x||(x=new u),x._init(e)},u.add=function(e,t){return x?x._add(e,t):!1},u.destroy=function(e,t){x&&x._remove(e,t)},u.pause=function(){x&&(x._fx3dFrameTask&&x._fx3dFrameTask.pause(),x.needsRender=!1)},u});