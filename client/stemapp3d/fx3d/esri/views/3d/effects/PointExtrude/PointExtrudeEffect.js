/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","esri/core/lang","esri/views/3d/webgl-engine/lib/VertexBufferLayout","esri/views/3d/webgl-engine/lib/Util","../../webgl-engine-extensions/GLXBO","../../support/fx3dUtils","../../support/fx3dUnits","../Effect","./PointExtrudeMaterial"],function(e,t,i,s,r,n,h,o,a,d,_){var g=n.VertexAttrConstants,l={Down:0,Up:1},u=40.11,m={Cuboid:"cuboid",Hexahedron:"hexahedron",Cylinder:"cylinder"},f={Cuboid:4,Hexahedron:6,Cylinder:20},y=t([d],{declaredClass:"esri.views.3d.effects.PointExtrude.PointExtrudeEffect",effectName:"PointExtrude",constructor:function(e){this.orderId=2,this._sizeInMeters=[]},_initRenderingInfo:function(){this.renderingInfo.radius=4e4,this.renderingInfo.height=8e5,this.renderingInfo.topColors=[o.rgbNames.cadetblue,o.rgbNames.yellowgreen,o.rgbNames.lightpink,o.rgbNames.orangered,o.rgbNames.green,o.rgbNames.indianred],this._colorBarDirty=!0,this.renderingInfo.bottomColor=[0,255,0],this.renderingInfo.shapeType=m.Cylinder,this._renderingInfoDirty=!0,this._segments=f.Cylinder,this._vacDirty=!0,this._shapeDirty=!0,this.inherited(arguments)},_doRenderingInfoChange:function(e){this.inherited(arguments);var t;for(t in e)e.hasOwnProperty(t)&&this.renderingInfo.hasOwnProperty(t)&&(s.endsWith(t.toLowerCase(),"info")?o.isInforAttrChanged(this.renderingInfo[t],e[t])&&(this._renderingInfoDirty=!0):s.endsWith(t.toLowerCase(),"color")?e[t]instanceof Array&&3==e[t].length&&(this.renderingInfo[t]=[e[t][0]/255,e[t][1]/255,e[t][2]/255]):s.endsWith(t.toLowerCase(),"colors")?e[t]instanceof Array&&(this.renderingInfo[t]=e[t],this._colorBarDirty=!0,this._renderingInfoDirty=!0):"shapetype"===t.toLowerCase()?(this._shapeDirty=!0,this._isAddingGeometry=!1,this._renderingInfoDirty=!0,this.renderingInfo[t]=e[t].toLowerCase(),this.renderingInfo[t]===m.Cuboid?this._segments=f.Cuboid:this.renderingInfo[t]===m.Hexahedron?this._segments=f.Hexahedron:this.renderingInfo[t]===m.Cylinder&&(this._segments=f.Cylinder)):"radius"===t.toLowerCase()||"height"===t.toLowerCase()||"transparency"===t.toLowerCase()?(this._clampScope(e,t),"radius"==t&&this._radiusUnit?this.renderingInfo[t]=a.toMeters(this._radiusUnit,e[t],this._view.viewingMode):"height"==t&&this._heightUnit?(this.renderingInfo[t]=a.toMeters(this._heightUnit,e[t],this._view.viewingMode),this._updateDefaultLabelHeight()):this.renderingInfo[t]=e[t]):typeof e[t]==typeof this.renderingInfo[t]&&(this.renderingInfo[t]=e[t]))},_updateDefaultLabelHeight:function(){this._layer._labelDefaultHeight={flag:1,min:this._scopes.height[0],max:this.renderingInfo.height}},setContext:function(t){this.inherited(arguments),this._effectConfig&&e.isArray(this._effectConfig.renderingInfo)&&(this._radiusUnit=null,this._heightUnit=null,i.forEach(this._effectConfig.renderingInfo,function(e){"radius"===e.name.toLowerCase()?(this._radiusUnit=e.unit,this.renderingInfo.radius=a.toMeters(this._radiusUnit,this.renderingInfo.radius,this._view.viewingMode)):"height"===e.name.toLowerCase()&&(this._heightUnit=e.unit,this.renderingInfo.height=a.toMeters(this._heightUnit,this.renderingInfo.height,this._view.viewingMode),this._updateDefaultLabelHeight())}.bind(this)))},destroy:function(){this._resetXBOs()},_resetXBOs:function(){this._dispose("_vbo"),this._dispose("_ibo")},_initVertexLayout:function(){this._vertexAttrConstants=[g.POSITION,g.AUXPOS1],this._vertexBufferLayout=new r(this._vertexAttrConstants,[3,3],[5126,5126]),this._material&&(this._material._vbLayout=this._vertexBufferLayout)},_initRenderContext:function(){return this.inherited(arguments),this._vacDirty&&(this._initVertexLayout(),this._resetXBOs(),this._vacDirty=!1),this._geometryVertexNum=2*this._segments,this._geometryIndexNum=3*(2*this._segments+(this._segments-2)),this._vbo||(this._vbo=new h(this._gl,!0,this._vertexBufferLayout)),this._ibo||(this._ibo=new h(this._gl,!1)),this._buildPolyHedronGeometries()},_buildPolyHedronGeometries:function(){var e=this._isAddingGeometry?this._addedGraphics:this._allGraphics(),t=this._isAddingGeometry?this._toAddGraphicsIndex:0;if(e.length>0){var i,s,r,n,h=this._vertexBufferLayout.getStride(),o=new Float32Array(e.length*h*this._geometryVertexNum),a=new Uint32Array(e.length*this._geometryIndexNum),d=0,_=0;for(s=0;s<e.length;s++)if(i=e[s],null!=i.geometry){for(r=0;r<this._segments;r++)d=(s*this._geometryVertexNum+r)*h,o[0+d]=i.geometry.longitude,o[1+d]=i.geometry.latitude,o[2+d]=i.geometry.altitude||1,o[3+d]=s+t,o[4+d]=r,o[5+d]=l.Down,d=(s*this._geometryVertexNum+r+this._segments)*h,o[0+d]=i.geometry.longitude,o[1+d]=i.geometry.latitude,o[2+d]=null==i.geometry.altitude?u:u+i.geometry.altitude,o[3+d]=s+t,o[4+d]=r,o[5+d]=l.Up,_=s*this._geometryIndexNum+6*r,n=this._geometryVertexNum*(s+t),r!==this._segments-1?(a[0+_]=r+n,a[1+_]=r+1+n,a[2+_]=r+1+this._segments+n,a[3+_]=r+n,a[4+_]=r+1+this._segments+n,a[5+_]=r+this._segments+n):(a[0+_]=r+n,a[1+_]=0+n,a[2+_]=0+this._segments+n,a[3+_]=r+n,a[4+_]=0+this._segments+n,a[5+_]=r+this._segments+n);for(n=0;n<this._segments-2;n++)_=s*this._geometryIndexNum+6*this._segments+3*n,a[0+_]=0+this._segments+(s+t)*this._geometryVertexNum,a[1+_]=1+this._segments+n+(s+t)*this._geometryVertexNum,a[2+_]=2+this._segments+n+(s+t)*this._geometryVertexNum}return this._vbo.addData(this._isAddingGeometry,o),this._ibo.addData(this._isAddingGeometry,a),this._resetAddGeometries(),!0}return!1},_loadShaders:function(){return this.inherited(arguments),this._material||(this._material=new _({gl:this._gl,vbLayout:this._vertexBufferLayout,shaderSnippets:this._shaderSnippets})),this._material.loadShaders()},_initColorBar:function(){if(!this._colorBarDirty)return!0;this._colorBarTexture||(this._colorBarTexture=this._gl.createTexture()),this._gl.bindTexture(3553,this._colorBarTexture),this._gl.pixelStorei(37440,!0),this._gl.texParameteri(3553,10240,9728),this._gl.texParameteri(3553,10241,9728),this._gl.texParameteri(3553,10242,33071),this._gl.texParameteri(3553,10243,33071);var e=o.createColorBarTexture(32,1,this.renderingInfo.topColors);return this._gl.texImage2D(3553,0,6408,6408,5121,e),this._gl.generateMipmap(3553),this._gl.bindTexture(3553,null),0===this._gl.getError()?!0:!1},render:function(t){this.inherited(arguments),this._layer.visible&&this.ready&&this._bindPramsReady()&&(this._sizeInMeters[0]=this.renderingInfo.radius,this._sizeInMeters[1]=this._scopes.height[0],this._sizeInMeters[2]=this.renderingInfo.height,this._material.bind(e.mixin({},{svte:this._vizFieldVerTextures[this._vizFieldDefault],evte:this._vizFieldVerTextures[this._vizFields[this._currentVizPage]],vfvs:this._vizFieldVerTextureSize,ail:this.renderingInfo.animationInterval,sz:this._sizeInMeters,tcy:this.renderingInfo.transparency,btc:this.renderingInfo.bottomColor,minValue:this._vizFieldMinMaxs[this._vizFieldDefault].min>this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].min?this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].min:this._vizFieldMinMaxs[this._vizFieldDefault].min,maxValue:this._vizFieldMinMaxs[this._vizFieldDefault].max>this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].max?this._vizFieldMinMaxs[this._vizFieldDefault].max:this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].max,sfr:1/this._segments,cbte:this._colorBarTexture},t)),this._vbo.bind(this._material.getProgram()),this._ibo.bind(),this._gl.drawElements(4,this._ibo.getNum(),5125,0),this._material.release(),this._vbo.unbind(),this._ibo.unbind())}});return y});