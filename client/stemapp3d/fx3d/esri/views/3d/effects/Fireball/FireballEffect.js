/**
 * Copyright @ 2016 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","esri/core/lang","esri/views/3d/webgl-engine/lib/VertexBufferLayout","esri/views/3d/webgl-engine/lib/Util","esri/views/3d/webgl-engine/lib/gl-matrix","../../webgl-engine-extensions/GLXBO","../../webgl-engine-extensions/GLVerTexture","../../support/fx3dUtils","../../support/fx3dUnits","../Effect","./FireballMaterial"],function(i,e,t,r,s,n,h,a,o,_,d,l,g){var u=(n.assert,h.vec3d),c=h.vec2,f=40.11,m=u.create(),v=u.create(),w=u.create(),x=n.VertexAttrConstants,p={ALONG:0,AROUND:1},b=e([l],{declaredClass:"esri.views.3d.effects.Fireball.FireballEffect",effectName:"Fireball",constructor:function(e){i.hitch(this,e),this.orderId=2,this._pathIdNum=0,this._tmpPoints=[],this._needsAllLoaded=!0},_initRenderingInfo:function(){this.renderingInfo.radius=40,this.renderingInfo.width=50,this.renderingInfo.height=50,this.renderingInfo.colors=[_.rgbNames.cadetblue,_.rgbNames.yellowgreen,_.rgbNames.lightpink,_.rgbNames.orangered,_.rgbNames.green,_.rgbNames.indianred],this._colorBarDirty=!0,this._renderingInfoDirty=!0,this._curveType=p.AROUND,this._vacDirty=!0,this._shapeDirty=!0,this.inherited(arguments)},_doRenderingInfoChange:function(i){this.inherited(arguments);var e;for(e in i)i.hasOwnProperty(e)&&this.renderingInfo.hasOwnProperty(e)&&(r.endsWith(e.toLowerCase(),"info")?_.isInforAttrChanged(this.renderingInfo[e],i[e])&&(this._renderingInfoDirty=!0):r.endsWith(e.toLowerCase(),"colors")?i[e]instanceof Array&&(this.renderingInfo[e]=i[e],this._colorBarDirty=!0,this._renderingInfoDirty=!0):"radius"===e.toLowerCase()||"width"===e.toLowerCase()||"height"===e.toLowerCase()||"transparency"===e.toLowerCase()?(this._clampScope(i,e),"radius"==e&&this._radiusUnit?this.renderingInfo[e]=d.toMeters(this._radiusUnit,i[e],this._view.viewingMode):"width"==e&&this._widthUnit?this.renderingInfo[e]=d.toMeters(this._widthUnit,i[e],this._view.viewingMode):"height"==e&&this._heightUnit?this.renderingInfo[e]=d.toMeters(this._heightUnit,i[e],this._view.viewingMode):this.renderingInfo[e]=i[e]):typeof i[e]==typeof this.renderingInfo[e]&&(this.renderingInfo[e]=i[e]))},setContext:function(e){this.inherited(arguments),this._effectConfig&&i.isArray(this._effectConfig.renderingInfo)&&(this._radiusUnit=null,this._widthUnit=null,this._heightUnit=null,t.forEach(this._effectConfig.renderingInfo,function(i){"radius"===i.name.toLowerCase()?(this._radiusUnit=i.unit,this.renderingInfo.radius=d.toMeters(this._radiusUnit,this.renderingInfo.radius,this._view.viewingMode)):"width"===i.name.toLowerCase()?(this._widthUnit=i.unit,this.renderingInfo.width=d.toMeters(this._widthUnit,this.renderingInfo.width,this._view.viewingMode)):"height"===i.name.toLowerCase()&&(this._heightUnit=i.unit,this.renderingInfo.height=d.toMeters(this._heightUnit,this.renderingInfo.height,this._view.viewingMode))}.bind(this)),this._aroundVerticesTexture=new o(this._gl),this._aroundVerticesTextureSize=c.create())},destroy:function(){this._resetXBOs(),this._dispose("_aroundVerticesTexture")},_resetXBOs:function(){this._dispose("_vbo"),this._dispose("_ibo"),this._dispose("_particleVBO")},_initVertexLayout:function(){this._vertexAttrConstants=[x.AUXPOS1],this._vertexBufferLayout=new s(this._vertexAttrConstants,[3],[5126]),this._material&&(this._material._vbLayout=this._vertexBufferLayout)},_initRenderContext:function(){return this.inherited(arguments),this._vacDirty&&(this._initVertexLayout(),this._resetXBOs(),this._vacDirty=!1),this._vbo||(this._vbo=new a(this._gl,!0,this._vertexBufferLayout)),this._particleVBO||(this._particleVBO=new a(this._gl,!0,this._vertexBufferLayout)),this._ibo||(this._ibo=new a(this._gl,!1)),this._curveType===p.AROUND?this._buildAroundPathGeometries():this._curveType===p.ALONG?this._buildAlongPathGeometries():!1},_buildAroundPathGeometries:function(){var i=this._allGraphics(),e=0;if(i.length>0){var r,s,n,h,a,o,d,l,g,c=0,x=[],p=[],b=0,y=0,M=1,I=[];this._isAddingGeometry||(this._pathIdNum=0,this._tmpPoints=[]);var T=this._vertexBufferLayout.getStride();return t.forEach(i,function(i,t){if(null!=i.geometry)for(o=i.geometry.paths,d=0;d<o.length;d++)if(!(o[d].length<2)){for(n=0,h=0,r=o[d][0],r[2]||(r[2]=f),s=o[d][o[d].length-1],s[2]||(s[2]=f),u.set3(r[0],r[1],r[2],m),"global"===this._view.viewingMode?_.wgs84ToSphericalEngineCoords(m,0,m,0):"local"===this._view.viewingMode&&_.wgs84ToWebMerc(m,0,m,0),u.set3(s[0],s[1],s[2],v),"global"===this._view.viewingMode?_.wgs84ToSphericalEngineCoords(v,0,v,0):"local"===this._view.viewingMode&&_.wgs84ToWebMerc(v,0,v,0),u.subtract(m,v,w),h=u.length(w),"global"===this._view.viewingMode?n=5e5>=h?18:1e6>=h?40:Math.floor(1e-5*h):"local"===this._view.viewingMode&&(n=1e6>=h?10:2e6>=h?18:Math.floor(6e-6*h)),n=2*n+1,l=0;n>l;l++)a=T*(l+b),x[0+a]=this._pathIdNum,x[1+a]=t+e,x[2+a]=l,n-1>l&&(c=2*(l+b-t),p[c+0]=l+b+e,p[c+1]=l+b+e+1);for(b+=n,M=Math.max(1,Math.floor(n/20)),g=0;M>g;g++)a=T*(g+y),I[0+a]=this._pathIdNum,I[1+a]=t+e,I[2+a]=18*g;y+=M,this._pathIdNum++,this._tmpPoints.push([r[0],r[1],r[2]]),this._tmpPoints.push([s[0],s[1],s[2]])}}.bind(this)),this._vbo.addData(this._isAddingGeometry,new Float32Array(x)),this._ibo.addData(this._isAddingGeometry,new Uint32Array(p)),this._particleVBO.addData(this._isAddingGeometry,new Float32Array(I)),this._resetAddGeometries(),this._initAroundVerticesTexture()}return!1},_buildAlongPathGeometries:function(){return!1},_initAroundVerticesTexture:function(){if(2*this._pathIdNum!==this._tmpPoints.length)return!1;var i=this._gl.getParameter(3379),e=2,t=this._pathIdNum*e,r=_.nextHighestPowerOfTwo(t);r>i&&(r=i,console.warn("Too many graphics, and some data will be discarded."));var s=Math.ceil(t/r);s=_.nextHighestPowerOfTwo(s),s>i&&(s=i,console.warn("Too many graphics, and some data will be discarded."));for(var n,h=new Float32Array(r*s*4),a=0;a<this._pathIdNum;a++)n=a*e*4,h[0+n]=a,h[1+n]=this._tmpPoints[a*e][0],h[2+n]=this._tmpPoints[a*e][1],h[3+n]=this._tmpPoints[a*e][2],h[4+n]=a,h[5+n]=this._tmpPoints[a*e+1][0],h[6+n]=this._tmpPoints[a*e+1][1],h[7+n]=this._tmpPoints[a*e+1][2];return this._aroundVerticesTexture.setData(r,s,h),c.set2(r,s,this._aroundVerticesTextureSize),!0},_initColourMap:function(){this._colourMapTexture||(this._colourMapTexture=this._gl.createTexture());var i=new Image;i.src=_.spriteImg;var e=this;return i.onload=function(){e._gl.bindTexture(3553,e._colourMapTexture),e._gl.pixelStorei(37440,!0),e._gl.texParameteri(3553,10240,9728),e._gl.texParameteri(3553,10241,9728),e._gl.texParameteri(3553,10242,33071),e._gl.texParameteri(3553,10243,33071),e._gl.texImage2D(3553,0,6408,6408,5121,i),e._gl.generateMipmap(3553),e._gl.bindTexture(3553,null)},0===this._gl.getError()?!0:!1},_loadShaders:function(){return this.inherited(arguments),this._material||(this._material=new g({gl:this._gl,vbLayout:this._vertexBufferLayout,shaderSnippets:this._shaderSnippets,local:"local"==this._view.viewingMode})),this._material.loadShaders()},_initColorBar:function(){if(!this._colorBarDirty)return!0;this._colorBarTexture||(this._colorBarTexture=this._gl.createTexture()),this._gl.bindTexture(3553,this._colorBarTexture),this._gl.pixelStorei(37440,!0),this._gl.texParameteri(3553,10240,9728),this._gl.texParameteri(3553,10241,9728),this._gl.texParameteri(3553,10242,33071),this._gl.texParameteri(3553,10243,33071);var i=_.createColorBarTexture(32,1,this.renderingInfo.colors);return this._gl.texImage2D(3553,0,6408,6408,5121,i),this._gl.generateMipmap(3553),this._gl.bindTexture(3553,null),0===this._gl.getError()?!0:!1},render:function(e){this.inherited(arguments),this._layer.visible&&this.ready&&this._bindPramsReady()&&(this._material.bind(i.mixin({},{avt:this._aroundVerticesTexture,avts:this._aroundVerticesTextureSize,cmt:this._colourMapTexture,vfv:this._vizFieldVerTextures[this._vizFields[this._currentVizPage]],vfvs:this._vizFieldVerTextureSize,ai:this.renderingInfo.animationInterval,brs:this.renderingInfo.radius,tcy:this.renderingInfo.transparency,minValue:this._vizFieldMinMaxs[this._vizFieldDefault].min>this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].min?this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].min:this._vizFieldMinMaxs[this._vizFieldDefault].min,maxValue:this._vizFieldMinMaxs[this._vizFieldDefault].max>this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].max?this._vizFieldMinMaxs[this._vizFieldDefault].max:this._vizFieldMinMaxs[this._vizFields[this._currentVizPage]].max,cbte:this._colorBarTexture},e)),this._material.bindBoolean("dph",!0),this._material.blend(1),this._vbo.bind(this._material.getProgram()),this._ibo.bind(),this._gl.drawElements(1,this._ibo.getNum(),5125,0),this._ibo.unbind(),this._vbo.unbind(),this._material.bindBoolean("dph",!1),this._material.blend(0),this._particleVBO.bind(this._material.getProgram()),this._gl.drawArrays(0,0,this._particleVBO.getNum()),this._particleVBO.unbind(),this._material.release())}});return b});